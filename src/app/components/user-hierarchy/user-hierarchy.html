<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">User Hierarchy</h1>
                <p class="text-gray-600 mt-2">
                    View your complete downline structure. You can expand/collapse nodes to see different levels.
                </p>
            </div>

            <div class="flex items-center space-x-2 mt-4 md:mt-0">
                <!-- Stats -->
                <div class="bg-white border rounded-lg px-4 py-2">
                    <p class="text-sm text-gray-600">Total Downline</p>
                    <p class="text-xl font-bold text-blue-600">{{ totalUsers }}</p>
                </div>

                <!-- Actions -->
                <button mat-raised-button color="primary" (click)="expandAll()">
                    <mat-icon>expand_all</mat-icon>
                    Expand All
                </button>
                <button mat-button (click)="collapseAll()">
                    <mat-icon>collapse_all</mat-icon>
                    Collapse All
                </button>
                <button mat-icon-button (click)="refresh()" [disabled]="loading">
                    <mat-icon>refresh</mat-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    @if (loading) {
    <div class="text-center py-12">
        <mat-spinner diameter="50" class="mx-auto"></mat-spinner>
        <p class="mt-4 text-gray-600">Loading hierarchy...</p>
    </div>
    }

    <!-- Empty State -->
    @if (!loading && dataSource.data.length === 0) {
    <div class="text-center py-12">
        <mat-icon class="text-gray-400 text-5xl mb-4">account_tree</mat-icon>
        <h3 class="text-xl font-medium text-gray-700 mb-2">No Users Found</h3>
        <p class="text-gray-600 mb-6">You haven't added any users to your downline yet.</p>
        <button mat-raised-button color="primary" routerLink="/users/create">
            <mat-icon class="mr-2">person_add</mat-icon>
            Add First User
        </button>
    </div>
    }

    <!-- Hierarchy Tree -->
    @if (!loading && dataSource.data.length > 0) {
    <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
        <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="p-4">
            <!-- Node with children template -->
            <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding class="py-3">
                <button mat-icon-button [attr.aria-label]="'Toggle ' + node.user.username" (click)="toggleNode(node)"
                    class="mr-2">
                    <mat-icon>
                        {{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
                    </mat-icon>
                </button>

                <!-- Node content -->
                <div class="flex items-center justify-between w-full border-b pb-3">
                    <div class="flex items-center space-x-4">
                        <!-- User Avatar -->
                        <div
                            class="h-12 w-12 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white">
                            <mat-icon>{{ getRoleIcon(node.user.role) }}</mat-icon>
                        </div>

                        <!-- User Info -->
                        <div>
                            <div class="flex items-center space-x-2">
                                <h3 class="font-bold text-gray-800">{{ node.user.username }}</h3>
                                <span [class]="getRoleColor(node.user.role)" class="flex items-center text-sm">
                                    <mat-icon class="text-xs mr-1">{{ getRoleIcon(node.user.role) }}</mat-icon>
                                    {{ node.user.role | titlecase }}
                                </span>
                                <span [class]="getLevelColor(node.user.level)"
                                    class="px-2 py-1 rounded-full text-xs font-medium">
                                    Level {{ node.user.level }}
                                </span>
                                <span class="text-xs text-gray-500">
                                    {{ node.children?.length || 0 }} downline users
                                </span>
                            </div>

                            <p class="text-gray-600 text-sm mt-1">{{ node.user.email }}</p>
                            <div class="flex items-center space-x-4 mt-2 text-sm">
                                <span [class]="getBalanceColor(node.user.balance)" class="font-medium">
                                    Balance: {{ formatCurrency(node.user.balance) }}
                                </span>
                                <span class="text-gray-500">
                                    Commission: {{ formatCurrency(node.user.commissionEarned) }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Status Indicators -->
                    <div class="flex items-center space-x-2">
                        <span class="text-xs px-2 py-1 rounded-full"
                            [class]="node.user.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                            {{ node.user.isActive ? 'Active' : 'Inactive' }}
                        </span>
                    </div>
                </div>
            </mat-tree-node>

            <!-- Node without children template -->
            <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding class="py-3">
                <!-- Node content -->
                <div class="flex items-center justify-between w-full border-b pb-3">
                    <div class="flex items-center space-x-4">
                        <!-- User Avatar -->
                        <div class="h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center">
                            <mat-icon class="text-blue-600">{{ getRoleIcon(node.user.role) }}</mat-icon>
                        </div>

                        <!-- User Info -->
                        <div>
                            <div class="flex items-center space-x-2">
                                <h3 class="font-bold text-gray-800">{{ node.user.username }}</h3>
                                <span [class]="getRoleColor(node.user.role)" class="flex items-center text-sm">
                                    <mat-icon class="text-xs mr-1">{{ getRoleIcon(node.user.role) }}</mat-icon>
                                    {{ node.user.role | titlecase }}
                                </span>
                                <span [class]="getLevelColor(node.user.level)"
                                    class="px-2 py-1 rounded-full text-xs font-medium">
                                    Level {{ node.user.level }}
                                </span>
                            </div>

                            <p class="text-gray-600 text-sm mt-1">{{ node.user.email }}</p>
                            <div class="flex items-center space-x-4 mt-2 text-sm">
                                <span [class]="getBalanceColor(node.user.balance)" class="font-medium">
                                    Balance: {{ formatCurrency(node.user.balance) }}
                                </span>
                                <span class="text-gray-500">
                                    Commission: {{ formatCurrency(node.user.commissionEarned) }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Status Indicators -->
                    <div class="flex items-center space-x-2">
                        <span class="text-xs px-2 py-1 rounded-full"
                            [class]="node.user.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                            {{ node.user.isActive ? 'Active' : 'Inactive' }}
                        </span>
                    </div>
                </div>
            </mat-tree-node>
        </mat-tree>
    </div>
    }

    <!-- Summary Stats -->
    @if (!loading && dataSource.data.length > 0) {
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Balance Summary -->
        <mat-card>
            <mat-card-header>
                <mat-card-title class="flex items-center">
                    <mat-icon class="mr-2 text-green-600">account_balance</mat-icon>
                    Total Downline Balance
                </mat-card-title>
            </mat-card-header>
            <mat-card-content class="p-4">
                <p class="text-3xl font-bold text-green-600">
                    {{ formatCurrency(calculateTotalBalance()) }}
                </p>
                <p class="text-gray-600 text-sm mt-2">Sum of all downline users' balances</p>
            </mat-card-content>
        </mat-card>

        <!-- Commission Summary -->
        <mat-card>
            <mat-card-header>
                <mat-card-title class="flex items-center">
                    <mat-icon class="mr-2 text-blue-600">monetization_on</mat-icon>
                    Total Commission Generated
                </mat-card-title>
            </mat-card-header>
            <mat-card-content class="p-4">
                <p class="text-3xl font-bold text-blue-600">
                    {{ formatCurrency(calculateTotalCommission()) }}
                </p>
                <p class="text-gray-600 text-sm mt-2">Total commission earned by downline</p>
            </mat-card-content>
        </mat-card>

        <!-- User Stats -->
        <mat-card>
            <mat-card-header>
                <mat-card-title class="flex items-center">
                    <mat-icon class="mr-2 text-purple-600">people</mat-icon>
                    User Distribution
                </mat-card-title>
            </mat-card-header>
            <mat-card-content class="p-4">
                <p class="text-3xl font-bold text-purple-600">{{ totalUsers }}</p>
                <p class="text-gray-600 text-sm mt-2">
                    {{ getActiveUsers() }} active, {{ getInactiveUsers() }} inactive
                </p>
            </mat-card-content>
        </mat-card>
    </div>
    }

    <!-- Legend -->
    <mat-card>
        <mat-card-header>
            <mat-card-title class="flex items-center">
                <mat-icon class="mr-2">legend_toggle</mat-icon>
                Hierarchy Legend
            </mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-center space-x-2">
                    <div class="h-4 w-4 rounded-full bg-blue-100"></div>
                    <span class="text-sm text-gray-600">Direct Downline (Level {{ (currentUser?.level || 0) + 1
                        }})</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="h-4 w-4 rounded-full bg-green-100"></div>
                    <span class="text-sm text-gray-600">Indirect Downline (Level {{ (currentUser?.level || 0) + 2
                        }}+)</span>
                </div>
                <div class="flex items-center space-x-2">
                    <mat-icon class="text-blue-600 text-sm">expand_more</mat-icon>
                    <span class="text-sm text-gray-600">Click to expand/collapse</span>
                </div>
            </div>

            <!-- Level Colors Legend -->
            <div class="mt-4">
                <h4 class="font-medium text-gray-700 mb-2">Level Colors:</h4>
                <div class="flex flex-wrap gap-2">
                    @for (i of [0,1,2,3,4,5]; track i) {
                    <span [class]="getLevelColor((currentUser?.level || 0) + i)" class="px-3 py-1 rounded-full text-xs">
                        Level {{ (currentUser?.level || 0) + i }}
                    </span>
                    }
                </div>
            </div>
        </mat-card-content>
    </mat-card>
</div>